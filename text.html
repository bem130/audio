<!DOCTYPE html>
<html>
    <head>
        <title>sound</title>
        <meta charset="utf-8">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Sound of the Text - bem130">
        <meta property="og:description" content="文字コードを音で聞きたい">
        <meta property="og:site_name" content="HarukSite">
        <meta name="twitter:site" content="@bem130">
    </head>
    <body>
        <h1>文字コードを耳で聞きたい</h1>
        <p>概要: テキストをutf-8でエンコードし、2桁の16進数に直す</p>
        <p>16進数に、ラ(440Hz)から、白鍵の音を割り振り、それを流す</p>
        <p>// 音を2つ流すごとに、短い無音を挟んでいます</p>
        <textarea id="text" class="bigarea"></textarea>
        <button onclick="playtext(document.getElementById('text').value)">play</button>
    </body>
</html>
<script>

let ACtx;
let playi = false;
let setuped = false;

var oscillator;
function setup() {
    ACtx  = new (window.AudioContext || window.webkitAudioContext)();
    oscillator = ACtx.createOscillator();
    oscillator.type = 'sin';
    sound(0);
    oscillator.start();
}

function sound(freq) {
    oscillator.frequency.value = freq; // value in hertz
    oscillator.connect(ACtx.destination);
}
function end() {
    sound(0);
}

function text_to_utf8(text) {
    return (new TextEncoder("utf-8")).encode(text);
}
function utf8_to_text(data) {
    return (new TextDecoder("utf-8")).decode(new Uint8Array(data));
}
function playtext(text) {
    let tmpdatas = text_to_utf8(text);
    let datas = [];
    for (let i=0;i<tmpdatas.length;i++) {
        datas.push(Math.floor((tmpdatas[i]-tmpdatas[i]%0x10)/0x10));
        datas.push(tmpdatas[i]%0x10);
    }
    {
        let dcdata = []
        for (let i=0;i<datas.length;i+=2) {
            dcdata.push(datas[i]*0x10+datas[i+1]);
        }
        console.log(utf8_to_text(dcdata))
    }
    let frqdata = [];
    for (let i=0;i<datas.length;i++) {
        frqdata.push(fr(220,nfreqs[datas[i]]));
    }
    splay(frqdata);
}
function fr(b,n) { // b Hzから半音nつ上
    return b*(2**(n/12))
}
nfreqs = [
    0,2,3,5,7,8,10, 12,14,15,17,20,22, 24,26,27,29,31,32,34, 36
]
beat = 150
delay = beat/2

var pcnt = 0;
function play(snds) {
    if (!setuped) {
        setup()
    }
    playi = true;
    pcnt = 0;
    play_o(snds)
    console.log(snds)
}
function splay(snds) {
    console.log(playi)
    if (playi) {
        playi = false;
        setTimeout(play,delay+beat+500,snds)
    }
    else {
        setTimeout(play,0,snds)
    }
}
function play_o(snds) {
    if (!playi) {
        end();
        playi = false;
    }
    else {
        sound(snds[pcnt]);
        if (pcnt<snds.length-1) {
            pcnt++;
            if (pcnt%2==0) {
                setTimeout(sound,beat,0)
                setTimeout(play_o,beat+delay,snds)
            }
            else {
                setTimeout(play_o,beat,snds)
            }
        }
        else {
            pcnt=0;
            setTimeout(end,beat)
            setTimeout(end,beat+11)
            playi = false;
        }
    }
}

</script>
<script>

document.getElementById("text").value = `enter text here\nand click the button on the right`

let params = location.href.split("?")[1]
    if (params!=null) {
        let spram = new URLSearchParams(params)
        pltext = spram.get("text");
        if (text!=null) {
            document.getElementById("text").value = pltext
        }
    }

</script>
<style>
.bigarea {
    height: 40vh;
    width: 50vw;
    font-size: 120%;
}
button {
    height: 30px;
    width: 120px;
}
</style>